---
description: Adopt UUID-based Id strategy with traceparent binding ID
---
# ADR-0017: Unified Identifier Strategy & traceparent Adoption

| Status | Date | Deciders |
| ------ | ---- | -------- |
| ✅ Accepted | 2025-07-27 | @core-team |

## Context

We need a coherent set of identifiers to address four separate concerns:
1. Entity identity (`entryId`, `userId`, `memoryId`).
2. Write deduplication (`Idempotency-Key`).
3. End-to-end correlation across retries and services (binding ID).
4. Per-attempt log correlation (request attempt ID).

Design doc `docs/design/id_strategy_and_observability.md` details the full scheme. This ADR records the architectural decision so future changes are traceable.

## Decision

Use the following IDs and headers:

| Purpose | Header / Field | Format | Generated by | Persisted |
|---------|----------------|--------|--------------|-----------|
| Deduplication | `Idempotency-Key` | UUID-v4 | Caller (SDK fallback) | SQLite `idempotency_key` |
| Binding / Trace | `traceparent` (Trace-ID) | 32-hex per W3C | SDK once per logical op | SQLite `trace_id` |
| Attempt logs | `Request-Id` | UUID-v4 | SDK per HTTP attempt | Not stored |
| Canonical entry | `entryId` | UUID-v4 | Backend | SQLite after sync |

Key points
* `traceparent` version 00, span-id zeros, flags `00` (not sampled).
* No `tracestate` header yet.
* Retry logic reuses Idempotency-Key and traceparent, but mint a fresh Request-Id.
* Backend echoes all three custom headers when present.

## Consequences
* Provides a durable breadcrumb (`trace_id`) without committing to full OpenTelemetry yet.
* Prepare for seamless future adoption of distributed tracing—just start populating span-ids and sampling.
* Minimal bandwidth impact (≈55 bytes per request).
* Avoids proliferation of bespoke "Correlation-Id" headers.

## Migration Plan
1. SQLite migration adding `idempotency_key` and `trace_id` columns.
2. SDK/header constants implemented (`Idempotency-Key`, `Request-Id`, `traceparent`).
3. Update API docs & checklist; backend echoes headers but can ignore logic initially.

## Alternatives Considered
| Option | Reason Rejected |
| ------ | --------------- |
| Custom `Correlation-Id` header | Not standard, no future tracing interop. |
| Full OTEL spans now | More code & infra than needed for MVP. |

## References
* W3C Trace Context spec
* Stripe Idempotency docs
* Design document: `docs/design/id_strategy_and_observability.md` 